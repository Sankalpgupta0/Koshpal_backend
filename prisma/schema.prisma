generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum Role {
  ADMIN
  HR
  EMPLOYEE
  COACH
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
}

enum AccountType {
  BANK
  CASH
  WALLET
  CREDIT_CARD
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum ConsultationStatus {
  REQUESTED
  APPROVED
  COMPLETED
  CANCELLED
}

enum UploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TransactionSource {
  MANUAL
  MOBILE
  BANK
}

//////////////////////
// CORE TABLES
//////////////////////

model Company {
  id                    String                @id @default(uuid())
  name                  String
  domain                String?               @unique
  employeeLimit         Int
  status                CompanyStatus         @default(ACTIVE)
  users                 User[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  hrprofiles            HRProfile[]
  employeeProfiles      EmployeeProfile[]
  employeeUploadBatches EmployeeUploadBatch[]
}

model User {
  id           String    @id @default(uuid())
  companyId    String?
  email        String    @unique
  passwordHash String
  role         Role
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?

  company Company? @relation(fields: [companyId], references: [id])

  adminProfile    AdminProfile?
  hrProfile       HRProfile?
  employeeProfile EmployeeProfile?
  coachProfile    CoachProfile?

  accounts      Account[]
  transactions  Transaction[]
  notifications Notification[]
  refreshTokens RefreshToken[]

  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  monthlySummaries      MonthlySummary[]
  employeeUploadBatches EmployeeUploadBatch[]

  @@index([companyId])
  @@index([role])
}

//////////////////////
// PROFILES
//////////////////////

model AdminProfile {
  userId   String @id
  fullName String

  user User @relation(fields: [userId], references: [id])
}

model HRProfile {
  userId      String  @id
  companyId   String
  fullName    String
  designation String?

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])
}

model EmployeeProfile {
  userId        String    @id
  companyId     String
  employeeCode  String?
  fullName      String
  phone         String?
  dateOfJoining DateTime?

  user          User           @relation(fields: [userId], references: [id])
  company       Company        @relation(fields: [companyId], references: [id])
  accounts      Account[]
}

model CoachProfile {
  userId          String   @id
  fullName        String
  expertise       String[]
  bio             String?
  rating          Decimal  @db.Decimal(3, 2) @default(0)
  successRate     Int      @default(0)
  clientsHelped   Int      @default(0)
  location        String?
  languages       String[]
  profilePhoto    String?

  user       User     @relation(fields: [userId], references: [id])
  slots      CoachSlot[]
}


//////////////////////
// FINANCIAL
//////////////////////

model Account {
  id              String      @id @default(uuid())
  userId          String
  employeeUserId  String?
  companyId       String
  type            AccountType
  provider        String?
  maskedAccountNo String?
  createdAt       DateTime    @default(now())

  user                  User             @relation(fields: [userId], references: [id])
  transactions          Transaction[]
  employeeProfile       EmployeeProfile? @relation(fields: [employeeProfileUserId], references: [userId])
  employeeProfileUserId String?

  @@index([userId])
  @@index([companyId])
}

model Transaction {
  id        String @id @default(uuid())
  userId    String
  companyId String
  accountId String

  amount      Decimal           @db.Decimal(12, 2)
  type        TransactionType
  category    String
  subCategory String?
  source      TransactionSource
  description String?

  transactionDate DateTime
  createdAt       DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  account Account @relation(fields: [accountId], references: [id])

  @@index([userId, transactionDate])
  @@index([companyId])
}

model MonthlySummary {
  id        String @id @default(uuid())
  userId    String
  companyId String

  month       Int
  year        Int
  periodStart DateTime
  periodEnd   DateTime

  totalIncome  Decimal @db.Decimal(12, 2)
  totalExpense Decimal @db.Decimal(12, 2)
  savings      Decimal @db.Decimal(12, 2)
  budget       Decimal @db.Decimal(12, 2) @default(0)

  categoryBreakdown Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, month, year])
  @@index([companyId])
}

//////////////////////
// HR UPLOAD TRACKING
//////////////////////

model EmployeeUploadBatch {
  id             String       @id @default(uuid())
  fileName       String
  totalRecords   Int          @default(0)
  successRecords Int          @default(0)
  failedRecords  Int          @default(0)
  status         UploadStatus @default(PENDING)
  // ðŸ”‘ Relations
  companyId      String
  company        Company      @relation(fields: [companyId], references: [id])
  hrUserId       String
  hrUser         User         @relation(fields: [hrUserId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([companyId])
  @@index([hrUserId])
}

//////////////////////
// NOTIFICATIONS
//////////////////////

model Notification {
  id      String  @id @default(uuid())
  userId  String
  title   String
  message String
  isRead  Boolean @default(false)

  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId, isRead])
}

//////////////////////
// WELLNESS
//////////////////////

model ConsultationBooking {
  id              String   @id @default(uuid())
  slotId          String   @unique
  coachId         String
  employeeId      String

  meetingLink     String
  calendarEventId String?
  status          BookingStatus @default(CONFIRMED)

  createdAt       DateTime @default(now())

  slot            CoachSlot @relation(fields: [slotId], references: [id])
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
}


model CoachSlot {
  id          String      @id @default(uuid())
  coachId     String
  date        DateTime    // yyyy-mm-dd (00:00)
  startTime   DateTime
  endTime     DateTime
  status      SlotStatus  @default(AVAILABLE)

  booking     ConsultationBooking?

  createdAt   DateTime    @default(now())

  coach       CoachProfile @relation(fields: [coachId], references: [userId])

  @@index([coachId, date])
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED
}

//////////////////////
// FINANCIAL GOALS
//////////////////////

model FinancialGoal {
  id          String   @id @default(uuid())
  userId      String
  goalName    String
  icon        String
  goalAmount  Decimal  @db.Decimal(12, 2)
  saving      Decimal  @db.Decimal(12, 2) @default(0)
  goalDate    DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

//////////////////////
// REFRESH TOKENS
//////////////////////

model RefreshToken {
  id          String    @id @default(uuid())
  userId      String
  token       String    @unique
  expiresAt   DateTime
  isRevoked   Boolean   @default(false)
  deviceId    String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRevoked])
  @@index([token])
  @@index([expiresAt])
}
